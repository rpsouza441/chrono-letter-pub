# ========================================
# Chrono Letter - Configuração Base
# ========================================

spring:
  application:
    name: chrono-letter

  # ----------------------------------------
  # Profiles: dev (default), prod, test
  # ----------------------------------------
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}

  # ----------------------------------------
  # Database (PostgreSQL)
  # ----------------------------------------
  datasource:
    url: ${DATABASE_URL:jdbc:postgresql://localhost:5432/chronoletter}
    username: ${DATABASE_USERNAME:chrono}
    password: ${DATABASE_PASSWORD:devpass}
    hikari:
      maximum-pool-size: ${DATABASE_POOL_SIZE:10}
      minimum-idle: 2
      connection-timeout: 20000

  jpa:
    hibernate:
      ddl-auto: validate  # Flyway gerencia o schema
    open-in-view: false   # Best practice: desabilitar OSIV
    properties:
      hibernate:
        format_sql: false
        jdbc:
          time_zone: UTC

  # ----------------------------------------
  # Flyway Migrations
  # ----------------------------------------
  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true

  # ----------------------------------------
  # Security
  # ----------------------------------------
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: ${GOOGLE_CLIENT_ID:}
            client-secret: ${GOOGLE_CLIENT_SECRET:}
            scope: openid, email, profile

  # ----------------------------------------
  # Email (SMTP)
  # ----------------------------------------
  mail:
    host: ${SMTP_HOST:localhost}
    port: ${SMTP_PORT:1025}
    username: ${SMTP_USERNAME:}
    password: ${SMTP_PASSWORD:}
    properties:
      mail:
        smtp:
          auth: ${SMTP_AUTH:false}
          starttls:
            enable: ${SMTP_STARTTLS:false}

# ========================================
# Application Custom Properties
# ========================================
chronoletter:
  # Hora local de envio (0-23)
  send-hour-local: ${SEND_HOUR_LOCAL:10}
  
  # Dias máximos para retry antes de FAILED
  retry-deadline-days: ${RETRY_DEADLINE_DAYS:2}
  
  # Caminho para master key (KEK) via Docker secret
  master-key-path: ${MASTER_KEY_SECRET_PATH:/run/secrets/master_key}
  
  # Versão atual da KEK (incrementar ao rotacionar)
  kek-version: ${KEK_VERSION:1}
  
  # Email remetente
  mail:
    from: ${MAIL_FROM:noreply@chronoletter.app}
    from-name: ${MAIL_FROM_NAME:Chrono Letter}

  # Frontend URL (para links em emails)
  frontend-url: ${FRONTEND_URL:http://localhost:3000}

# ========================================
# Actuator / Observability
# ========================================
management:
  endpoints:
    web:
      exposure:
        include: health, info, prometheus, metrics
  endpoint:
    health:
      show-details: when_authorized
  prometheus:
    metrics:
      export:
        enabled: true

# ========================================
# Server
# ========================================
server:
  port: ${SERVER_PORT:8080}
  error:
    include-message: never
    include-stacktrace: never
